<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>結帳 - 竹意軒的咖啡工坊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; }
        .form-input { appearance: none; border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.75rem 1rem; width: 100%; transition: box-shadow 0.2s, border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #A0522D; box-shadow: 0 0 0 3px rgba(160, 82, 45, 0.2); }
        .font-noto-serif { font-family: 'Noto Serif TC', serif; }
    </style>
</head>
<body>
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-3">
            <div>
                <a href="/coffee/index.html" class="flex items-end gap-1">
                    <img src="/images/New logo.png" alt="竹意軒 Logo" class="h-12 w-auto">
                    <span class="font-noto-serif text-gray-600 text-sm leading-none pb-2">咖啡工坊</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
            <section>
                <button id="back-btn" class="text-gray-600 hover:text-amber-800 mb-6">&larr; 返回上一步</button>
                <h2 id="form-title" class="text-3xl font-bold text-gray-800 mb-8">載入中...</h2>
                
                <form id="home-delivery-form" style="display: none;" class="space-y-6">
                    </form>

                <form id="cvs-form" style="display: none;" class="space-y-6">
                    <div><label for="cvs-name" class="block text-sm font-medium text-gray-700 mb-2">取件人姓名</label><input type="text" id="cvs-name" name="name" required class="form-input"></div>
                    <div><label for="cvs-phone" class="block text-sm font-medium text-gray-700 mb-2">取件人行動電話</label><input type="tel" id="cvs-phone" name="phone" required class="form-input" placeholder="請輸入 09 開頭的 10 位數字"></div>
                    <div><label for="cvs-email" class="block text-sm font-medium text-gray-700 mb-2">電子郵件 (用於接收訂單通知)</label><input type="email" id="cvs-email" name="email" required class="form-input" placeholder="請輸入有效的 Email 地址"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">取貨門市</label><div id="selected-store-info" class="p-4 bg-gray-100 rounded-md text-gray-700 min-h-[50px]">尚未選擇門市</div><button type="button" id="select-store-btn" class="mt-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 font-bold py-2 px-4 rounded-lg">選擇 7-ELEVEN 門市</button></div>
                    <div class="border-t pt-4"><label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label><div class="space-y-2"><label class="flex items-center"><input type="radio" name="payment" value="CreditCard" checked class="h-4 w-4 text-amber-600 border-gray-300 focus:ring-amber-500"> <span class="ml-2">信用卡付款</span></label><label class="flex items-center"><input type="radio" name="payment" value="COD" class="h-4 w-4 text-amber-600 border-gray-300 focus:ring-amber-500"> <span class="ml-2">取貨付款</span></label></div></div>
                </form>
            </section>
            
            <aside class="bg-white p-8 rounded-lg shadow-md h-fit">
                </aside>
        </div>
    </main>
    
    <form id="ecpay-map-form" method="POST" action="https://logistics.ecpay.com.tw/Express/map" style="display: none;">
        <input type="hidden" name="MerchantID" />
        <input type="hidden" name="MerchantTradeNo" />
        <input type="hidden" name="LogisticsType" value="CVS" />
        <input type="hidden" name="LogisticsSubType" value="UNIMARTC2C" />
        <input type="hidden" name="IsCollection" value="Y" />
        <input type="hidden" name="ServerReplyURL" />
    </form>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 變數與元素定義 (前半部大致不變) ---
        const shippingMethod = localStorage.getItem('shippingMethod');
        const cart = JSON.parse(localStorage.getItem('bamboo_cart') || '[]');
        const cvsForm = document.getElementById('cvs-form');
        const selectStoreBtn = document.getElementById('select-store-btn');
        const selectedStoreInfoDiv = document.getElementById('selected-store-info');
        const cvsNameInput = document.getElementById('cvs-name');
        const cvsPhoneInput = document.getElementById('cvs-phone');
        const cvsEmailInput = document.getElementById('cvs-email');
        const ecpayMapForm = document.getElementById('ecpay-map-form');
        let selectedStore = null;

        // --- 頁面初始化與訂單摘要 (省略未修改部分) ---
        // ... (此處程式碼與舊版相同)

        // 【核心修改】從 sessionStorage 還原資料
        function restoreData() {
            // 1. 還原使用者填寫的表單資料
            const savedCvsData = sessionStorage.getItem('cvsFormData');
            if (savedCvsData) {
                const data = JSON.parse(savedCvsData);
                cvsNameInput.value = data.name || '';
                cvsPhoneInput.value = data.phone || '';
                cvsEmailInput.value = data.email || '';
            }

            // 2. 還原從綠界回傳的門市資料
            const storeDataString = sessionStorage.getItem('ecpayStoreData');
            if (storeDataString) {
                selectedStore = JSON.parse(storeDataString);
                selectedStoreInfoDiv.innerHTML = `<p class="font-bold">${selectedStore.CVSStoreName} (${selectedStore.CVSStoreID})</p><p class="text-sm">${selectedStore.CVSAddress}</p>`;
                selectedStoreInfoDiv.classList.remove('text-gray-700');
                selectedStoreInfoDiv.classList.add('text-green-800');
            }

            // 3. 還原後清除暫存，避免重複使用
            sessionStorage.removeItem('cvsFormData');
            sessionStorage.removeItem('ecpayStoreData');
        }

        // 頁面載入時，執行一次還原
        restoreData();
        
        // 【核心修改】點擊選擇門市按鈕的邏輯
        selectStoreBtn.addEventListener('click', () => {
            // 1. 儲存目前使用者已輸入的資料到 sessionStorage
            const cvsDataToSave = {
                name: cvsNameInput.value,
                phone: cvsPhoneInput.value,
                email: cvsEmailInput.value
            };
            sessionStorage.setItem('cvsFormData', JSON.stringify(cvsDataToSave));

            // 2. 準備 ECPay 表單需要的資料
            const merchantIDInput = ecpayMapForm.querySelector('input[name="MerchantID"]');
            const merchantTradeNoInput = ecpayMapForm.querySelector('input[name="MerchantTradeNo"]');
            const serverReplyURLInput = ecpayMapForm.querySelector('input[name="ServerReplyURL"]');
            
            // ❗❗❗ 請務必將 '3002607' 換成您自己的特店編號 ❗❗❗
            merchantIDInput.value = '3002607'; 
            merchantTradeNoInput.value = `bamboo${new Date().getTime()}`;
            serverReplyURLInput.value = `${window.location.origin}/.netlify/functions/ecpay-map-return`;

            // 3. 提交表單，直接在本頁跳轉至綠界電子地圖
            ecpayMapForm.submit();
        });

        // --- 確認訂購按鈕事件 (邏輯不變) ---
        // ... (此處程式碼與舊版相同)
    });
    </script>
</body>
</html>